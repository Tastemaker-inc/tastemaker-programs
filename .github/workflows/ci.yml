name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SOLANA_VERSION: "3.0.8"
  ANCHOR_VERSION: "0.32.1"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Install Solana CLI
        run: |
          curl -sSfL --retry 5 --retry-delay 5 -L \
            "https://github.com/anza-xyz/agave/releases/download/v${SOLANA_VERSION}/solana-release-x86_64-unknown-linux-gnu.tar.bz2" \
            -o /tmp/solana.tar.bz2
          tar -xjf /tmp/solana.tar.bz2 -C /tmp
          echo "/tmp/solana-release/bin" >> $GITHUB_PATH

      - name: Verify Solana CLI
        run: solana --version

      - name: Install Anchor CLI
        run: |
          curl -sSfL --retry 5 --retry-delay 5 -L \
            "https://github.com/solana-foundation/anchor/releases/download/v${ANCHOR_VERSION}/anchor-${ANCHOR_VERSION}-x86_64-unknown-linux-gnu" \
            -o /usr/local/bin/anchor
          chmod +x /usr/local/bin/anchor
          anchor --version

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Ensure program keypairs exist (for fresh clone or cache miss)
        run: |
          mkdir -p target/deploy
          for program in governance otc_market project_escrow revenue_distribution rwa_token taste_token; do
            if [ ! -f "target/deploy/${program}-keypair.json" ]; then
              solana-keygen new -o "target/deploy/${program}-keypair.json" --no-bip39-passphrase --force
            fi
          done

      - name: Sync program keys for CI
        run: anchor keys sync

      - name: Build (production)
        run: anchor build

      - name: Check Rust formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings -A unexpected_cfgs

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Install Solana CLI
        run: |
          curl -sSfL --retry 5 --retry-delay 5 -L \
            "https://github.com/anza-xyz/agave/releases/download/v${SOLANA_VERSION}/solana-release-x86_64-unknown-linux-gnu.tar.bz2" \
            -o /tmp/solana.tar.bz2
          tar -xjf /tmp/solana.tar.bz2 -C /tmp
          echo "/tmp/solana-release/bin" >> $GITHUB_PATH

      - name: Verify Solana CLI
        run: solana --version

      - name: Install Anchor CLI
        run: |
          curl -sSfL --retry 5 --retry-delay 5 -L \
            "https://github.com/solana-foundation/anchor/releases/download/v${ANCHOR_VERSION}/anchor-${ANCHOR_VERSION}-x86_64-unknown-linux-gnu" \
            -o /usr/local/bin/anchor
          chmod +x /usr/local/bin/anchor
          anchor --version

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Sync program keys for CI
        run: anchor keys sync

      - name: Generate test wallet
        run: |
          solana-keygen new -o scripts/test-wallet.json --no-bip39-passphrase --force

      - name: Run full test suite
        run: npm run test:full
